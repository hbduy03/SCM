<!-- templates/core/dashboard_warehouse.html -->

{% extends "layout.html" %}
{% load static %}
{% block content %}

<div class="page-wrapper">
    <div class="content">
        <div class="page-header">
            <div class="page-title">
                <h4>Dashboard - Warehouse</h4>
                <h6>Quản lý kho hàng</h6>
            </div>
        </div>

        <!-- STATS CARDS -->
        <div class="row">
            <div class="col-lg-3 col-sm-6 col-12">
                <div class="dash-widget">
                    <div class="dash-widgetimg">
                        <span><img src="{% static 'assets/img/icons/dash1.svg' %}" alt="img"></span>
                    </div>
                    <div class="dash-widgetcontent">
                        <h5>{{ stats.total_inventory_value|floatformat:0 }} <span>₫</span></h5>
                        <h6>Giá trị tồn kho</h6>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-sm-6 col-12">
                <div class="dash-widget dash1">
                    <div class="dash-widgetimg">
                        <span><img src="{% static 'assets/img/icons/dash2.svg' %}" alt="img"></span>
                    </div>
                    <div class="dash-widgetcontent">
                        <h5>{{ stats.pending_orders }}</h5>
                        <h6>Đơn chờ xuất kho</h6>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-sm-6 col-12">
                <div class="dash-widget dash2">
                    <div class="dash-widgetimg">
                        <span><img src="{% static 'assets/img/icons/dash3.svg' %}" alt="img"></span>
                    </div>
                    <div class="dash-widgetcontent">
                        <h5>{{ stats.stock_in_today }}</h5>
                        <h6>Nhập kho hôm nay</h6>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-sm-6 col-12">
                <div class="dash-widget dash3">
                    <div class="dash-widgetimg">
                        <span><img src="{% static 'assets/img/icons/dash4.svg' %}" alt="img"></span>
                    </div>
                    <div class="dash-widgetcontent">
                        <h5>{{ stats.low_stock_items }}</h5>
                        <h6>Hàng sắp hết</h6>
                    </div>
                </div>
            </div>
        </div>

        <!-- CHARTS ROW -->
        <div class="row">
            <!-- Biểu đồ nhập/xuất kho -->
            <div class="col-lg-8 col-sm-12 col-12 d-flex">
                <div class="card flex-fill">
                    <div class="card-header pb-0">
                        <h5 class="card-title mb-0">Nhập/Xuất kho 7 ngày gần đây</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="stockMovementChart" height="100"></canvas>
                    </div>
                </div>
            </div>

            <!-- Biểu đồ trạng thái tồn kho -->
            <div class="col-lg-4 col-sm-12 col-12 d-flex">
                <div class="card flex-fill">
                    <div class="card-header pb-0">
                        <h5 class="card-title mb-0">Trạng thái tồn kho</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="inventoryStatusChart" height="150"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- TABLES ROW -->
        <div class="row">
            <!-- Đơn hàng chờ xuất kho -->
            <div class="col-lg-6 col-sm-12 col-12 d-flex">
                <div class="card flex-fill">
                    <div class="card-header pb-0 d-flex justify-content-between align-items-center">
                        <h4 class="card-title mb-0">Đơn hàng chờ xuất kho</h4>
                        <div class="graph-sets">
                            <a href="{% url 'order_list' %}?status=pending"><button class="btn btn-white btn-sm">Xem tất cả</button></a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Mã đơn</th>
                                        <th>Khách hàng</th>
        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for order in pending_orders %}
                                    <tr>
                                        <td><a href="{% url 'order_detail' order.pk %}">{{ order.order_code }}</a></td>
                                        <td>{{ order.customer_name }}</td>
                                        <td>
                                            <a class="btn btn-sm btn-success" href="{% url 'order_confirm' order.pk %}">
                                                <i class="fas fa-check me-1"></i>Xuất kho
                                            </a>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="3" class="text-center text-muted">Không có đơn hàng chờ xuất kho</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sản phẩm sắp hết hàng -->
            <div class="col-lg-6 col-sm-12 col-12 d-flex">
                <div class="card flex-fill">
                    <div class="card-header pb-0 d-flex justify-content-between align-items-center">
                        <h4 class="card-title mb-0">Cảnh báo hàng sắp hết</h4>
                        <div class="graph-sets">
                            <a href="{% url 'inventory_list' %}"><button class="btn btn-white btn-sm">Xem tất cả</button></a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Sản phẩm</th>
                                        <th>Còn lại</th>
                                        <th>Tối thiểu</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for inv in low_stock_products %}
                                    <tr>
                                        <td>{{ inv.product.name }}</td>
                                        <td><span class="badges bg-lightred">{{ inv.quantity }}</span></td>
                                        <td>{{ inv.min_quantity }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="3" class="text-center text-muted">Tất cả sản phẩm đều đủ hàng</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RECENT ACTIVITIES -->
        <div class="row">
            <!-- Nhập kho gần đây -->
            <div class="col-lg-6 col-sm-12 col-12 d-flex">
                <div class="card flex-fill">
                    <div class="card-header pb-0">
                        <h4 class="card-title mb-0">Nhập kho gần đây</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Sản phẩm</th>
                                        <th>Số lượng</th>
                                        <th>Nhà cung cấp</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for stock_in in recent_stock_in %}
                                    <tr>
                                        <td>{{ stock_in.product.name }}</td>
                                        <td><span class="badges bg-lightgreen">+{{ stock_in.quantity }}</span></td>
                                        <td>{{ stock_in.supplier.name }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="3" class="text-center text-muted">Chưa có hoạt động</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Xuất kho gần đây -->
            <div class="col-lg-6 col-sm-12 col-12 d-flex">
                <div class="card flex-fill">
                    <div class="card-header pb-0">
                        <h4 class="card-title mb-0">Xuất kho gần đây</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Sản phẩm</th>
                                        <th>Số lượng</th>
                                        <th>Loại</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for stock_out in recent_stock_out %}
                                    <tr>
                                        <td>{{ stock_out.product.name }}</td>
                                        <td><span class="badges bg-lightred">-{{ stock_out.quantity }}</span></td>
                                        <td>{{ stock_out.get_type_display }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="3" class="text-center text-muted">Chưa có hoạt động</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ========== STOCK MOVEMENT CHART (Nhập/Xuất) ==========
const stockMovementData = {{ stock_movement|safe }};
const stockMovementCtx = document.getElementById('stockMovementChart').getContext('2d');
new Chart(stockMovementCtx, {
    type: 'bar',
    data: {
        labels: stockMovementData.map(d => d.date),
        datasets: [
            {
                label: 'Nhập kho',
                data: stockMovementData.map(d => d.stock_in),
                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            },
            {
                label: 'Xuất kho',
                data: stockMovementData.map(d => d.stock_out),
                backgroundColor: 'rgba(255, 99, 132, 0.6)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 1
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'top'
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// ========== INVENTORY STATUS CHART (Doughnut) ==========
const inventoryStatusData = {{ inventory_status|safe }};
const inventoryStatusCtx = document.getElementById('inventoryStatusChart').getContext('2d');
new Chart(inventoryStatusCtx, {
    type: 'doughnut',
    data: {
        labels: ['Sắp hết', 'Bình thường', 'Tồn cao'],
        datasets: [{
            data: [
                inventoryStatusData.low_stock,
                inventoryStatusData.normal,
                inventoryStatusData.overstock
            ],
            backgroundColor: [
                'rgba(255, 99, 132, 0.7)',
                'rgba(75, 192, 192, 0.7)',
                'rgba(255, 206, 86, 0.7)'
            ],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});
</script>

{% endblock %}