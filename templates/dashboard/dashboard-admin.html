
{% extends "layout.html" %}
{% load static %}
{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<div class="page-wrapper">
<div class="content">
<div class="page-header">
<div class="page-title">
<h4>Dashboard - Admin</h4>
<h6>System Overview</h6>
</div>
</div>

<!-- STATS CARDS -->
<div class="row">
<div class="col-lg-3 col-sm-6 col-12">
<div class="dash-widget">
<div class="dash-widgetimg">
<span><img src="{% static 'assets/img/icons/dash1.svg' %}" alt="img"></span>
</div>
<div class="dash-widgetcontent">
<h5>{{ stats.total_revenue|floatformat:0 }} <span>₫</span></h5>
<h6>Total Revenue</h6>
</div>
</div>
</div>
<div class="col-lg-3 col-sm-6 col-12">
<div class="dash-widget dash1">
<div class="dash-widgetimg">
<span><img src="{% static 'assets/img/icons/dash2.svg' %}" alt="img"></span>
</div>
<div class="dash-widgetcontent">
<h5>{{ stats.total_orders }}</h5>
<h6>Total Orders</h6>
</div>
</div>
</div>
<div class="col-lg-3 col-sm-6 col-12">
<div class="dash-widget dash2">
<div class="dash-widgetimg">
<span><img src="{% static 'assets/img/icons/dash3.svg' %}" alt="img"></span>
</div>
<div class="dash-widgetcontent">
<h5>{{ stats.pending_orders }}</h5>
<h6>Pending Orders</h6>
</div>
</div>
</div>
<div class="col-lg-3 col-sm-6 col-12">
<div class="dash-widget dash3">
<div class="dash-widgetimg">
<span><img src="{% static 'assets/img/icons/dash4.svg' %}" alt="img"></span>
</div>
<div class="dash-widgetcontent">
<h5>{{ stats.low_stock_items }}</h5>
<h6>Low Stock Items</h6>
</div>
</div>
</div>
</div>

{% if ai_available and ai_forecast %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header pb-0 d-flex justify-content-between align-items-center">
                <h4 class="card-title mb-0">
                    <i class="fas fa-brain me-2"></i> AI Demand Forecast (30 Days)
                </h4>
                <span class="badge bg-success"><i class="fas fa-check"></i> Model Ready</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table datanew">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th class="text-center">Current Stock</th>
                                <th class="text-center">Forecast</th>
                                <th class="text-center">Shortage</th>
                                <th class="text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in ai_forecast %}
                            <tr>
                                <td class="fw-bold">{{ item.product_name }}</td>
                                <td class="text-center">{{ item.current_stock }}</td>
                                <td class="text-center text-info">{{ item.forecast }}</td>
                                <td class="text-center">
                                    {% if item.shortage > 0 %}
                                        <span class="text-danger fw-bold">-{{ item.shortage }}</span>
                                    {% else %}
                                        <span class="text-success"><i class="fas fa-check"></i> OK</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if item.urgency == 'Critical' %}
                                        <span class="badge bg-danger">Critical</span>
                                    {% elif item.urgency == 'High' %}
                                        <span class="badge bg-warning">High Risk</span>
                                    {% else %}
                                        <span class="badge bg-success">Normal</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
<!-- CHARTS ROW 1 -->
<div class="row">
<div class="col-lg-7 col-sm-12 col-12 d-flex">
<div class="card flex-fill">
<div class="card-header pb-0 d-flex justify-content-between align-items-center">
<h5 class="card-title mb-0">Revenue last 7 Days</h5>
</div>
<div class="card-body">
<canvas id="revenueChart" height="100"></canvas>
</div>
</div>
</div>

<!-- Biểu đồ đơn hàng theo trạng thái -->
<div class="col-lg-5 col-sm-12 col-12 d-flex">
<div class="card flex-fill">
<div class="card-header pb-0 d-flex justify-content-between align-items-center">
<h5 class="card-title mb-0">Orders by Status</h5>
</div>
<div class="card-body">
<canvas id="orderStatusChart" height="150"></canvas>
</div>
</div>
</div>
</div>

<!-- TABLES ROW -->
<div class="row">
<!-- Đơn hàng gần đây -->
<div class="col-lg-7 col-sm-12 col-12 d-flex">
<div class="card flex-fill">
<div class="card-header pb-0 d-flex justify-content-between align-items-center">
<h4 class="card-title mb-0">Recent Order</h4>
<div class="graph-sets">
<a href="{% url 'order_list' %}"><button class="btn btn-white btn-sm">View All</button></a>
</div>
</div>
<div class="card-body">
<div class="table-responsive">
<table class="table datanew">
<thead>
<tr>
<th>ID</th>
<th>Customer</th>
<th>Status</th>
<th>Total</th>
</tr>
</thead>
<tbody>
{% for order in recent_orders %}
<tr>
<td><a href="{% url 'order_detail' order.pk %}">{{ order.order_id }}</a></td>
<td>{{ order.customer_name }}</td>
<td>
{% if order.status == 'pending' %}
<span class="badge bg-warning text-dark">
<i class="fas fa-clock me-1"></i>{{ order.get_status_display }}
</span>
{% elif order.status == 'confirmed' %}
<span class="badge bg-info">
<i class="fas fa-spinner me-1"></i>{{ order.get_status_display }}
</span>
{% elif order.status == 'shipped' %}
<span class="badge bg-primary">
<i class="fas fa-shipping-fast me-1"></i>{{ order.get_status_display }}
</span>
{% elif order.status == 'delivered' %}
<span class="badge bg-success">
<i class="fas fa-check-circle me-1"></i>{{ order.get_status_display }}
</span>
{% else %}
<span class="badge bg-danger">
<i class="fas fa-times-circle me-1"></i>{{ order.get_status_display }}
</span>
{% endif %}
</td>
<td>{{ order.total_amount|floatformat:0 }} ₫</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
</div>
</div>
</div>

<!-- Cảnh báo tồn kho -->
<div class="col-lg-5 col-sm-12 col-12 d-flex">
<div class="card flex-fill">
<div class="card-header pb-0 d-flex justify-content-between align-items-center">
<h4 class="card-title mb-0">Low Stock Alerts</h4>
<div class="graph-sets">
<a href="{% url 'inventory_list' %}"><button class="btn btn-white btn-sm">View All</button></a>
</div>
</div>
<div class="card-body">
<div class="table-responsive">
<table class="table datanew">
<thead>
<tr>
<th>Product</th>
<th>Remain</th>
</tr>
</thead>
<tbody>
{% for inv in low_stock_products %}
<tr>
<td>{{ inv.product.name }}</td>
<td><span class="badges bg-lightred">{{ inv.quantity }} {{ inv.product.unit }}</span></td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>

<script>
// ========== REVENUE CHART (7 ngày) ==========
const revenueData = {{ revenue_by_day|safe }};
const revenueCtx = document.getElementById('revenueChart').getContext('2d');
new Chart(revenueCtx, {
type: 'line',
data: {
labels: revenueData.map(d => d.date),
datasets: [{
    label: 'Doanh thu (₫)',
    data: revenueData.map(d => d.revenue),
    borderColor: 'rgb(75, 192, 192)',
    backgroundColor: 'rgba(75, 192, 192, 0.2)',
    tension: 0.4,
    fill: true
}]
},
options: {
responsive: true,
maintainAspectRatio: true,
plugins: {
    legend: {
        display: false
    }
},
scales: {
    y: {
        beginAtZero: true,
        ticks: {
            callback: function(value) {
                return value.toLocaleString('vi-VN') + '₫';
            }
        }
    }
}
}
});

// ========== ORDER STATUS CHART (Pie) ==========
const orderStatusData = {{ order_status_data|safe }};
const orderStatusCtx = document.getElementById('orderStatusChart').getContext('2d');
new Chart(orderStatusCtx, {
type: 'doughnut',
data: {
labels: orderStatusData.map(d => d.status),
datasets: [{
    data: orderStatusData.map(d => d.count),
    backgroundColor: [
        'rgba(255, 206, 86, 0.7)',
        'rgba(54, 162, 235, 0.7)',
        'rgba(153, 102, 255, 0.7)',
        'rgba(75, 192, 192, 0.7)',
        'rgba(255, 99, 132, 0.7)'
    ],
    borderWidth: 1
}]
},
options: {
responsive: true,
maintainAspectRatio: true,
plugins: {
    legend: {
        position: 'bottom'
    }
}
}
});

const forecastData = {{ ai_forecast|safe }};

    if (forecastData) {
        const ctx = document.getElementById('forecastChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: forecastData.labels,
                datasets: forecastData.datasets
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: { position: 'top' },
                    title: {
                        display: true,
                        text: 'Top 5 Highest Demand Products Forecast'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Expected Demand' }
                    }
                }
            }
        });
    }
</script>

{% endblock %}
