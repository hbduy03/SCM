{% extends "layout.html" %}
{% load static %}
{% block content %}

<div class="page-wrapper">
<div class="content">
<div class="page-header">
<div class="page-title">
<h4>{{ title }}</h4>
<h6>Order Form</h6>
</div>
<div class="page-btn">
<a href="{% url 'stock_in_list' %}" class="btn btn-secondary">
<i class="fas fa-arrow-left me-1"></i>Go back
</a>
</div>
</div>
{% if messages %}
{% for message in messages %}
<div class="alert alert-danger">{{ message }}</div>
{% endfor %}
{% endif %}
<div class="card">
<div class="card-body">
<form method="POST" id="orderForm">
{% csrf_token %}

<div class="row">
<div class="col-lg-12">
<h5 class="card-title mb-3">
<i class="fas fa-user me-2"></i>Customer Information
</h5>
</div>

<div class="col-lg-4 col-sm-6 col-12">
<div class="form-group">
<label>Customer Name <span class="text-danger">*</span></label>
{{ order_form.customer_name }}
{% if order_form.customer_name.errors %}
    <small class="text-danger">{{ order_form.customer_name.errors }}</small>
{% endif %}
</div>
</div>

<div class="col-lg-4 col-sm-6 col-12">
<div class="form-group">
<label>Phone Number <span class="text-danger">*</span></label>
{{ order_form.customer_phone }}
{% if order_form.customer_phone.errors %}
    <small class="text-danger">{{ order_form.customer_phone.errors }}</small>
{% endif %}
</div>
</div>

<div class="col-lg-4 col-sm-6 col-12">
<div class="form-group">
<label>Email</label>
{{ order_form.customer_email }}
{% if order_form.customer_email.errors %}
    <small class="text-danger">{{ order_form.customer_email.errors }}</small>
{% endif %}
</div>
</div>

<div class="col-lg-12">
<div class="form-group">
<label>Delivery Address <span class="text-danger">*</span></label>
{{ order_form.customer_address }}
{% if order_form.customer_address.errors %}
    <small class="text-danger">{{ order_form.customer_address.errors }}</small>
{% endif %}
</div>
</div>
</div>

<hr class="my-4">

<div class="row">
<div class="col-lg-12">
<div class="d-flex justify-content-between align-items-center mb-3">
<h5 class="card-title">
    <i class="fas fa-shopping-cart me-2"></i>Order Items
</h5>
<button type="button" class="btn btn-primary btn-sm" id="addItemBtn">
    <i class="fas fa-plus me-1"></i>Add Product
</button>
</div>
</div>

<div class="col-lg-12">
{{ order_item_formset.management_form }}

<div class="table-responsive">
<table class="table table-bordered" id="productTable">
    <thead class="table-light">
        <tr>
            <th width="35%">Product</th>
            <th width="15%">Unit Price</th>
            <th width="12%">Quantity</th>
            <th width="10%">Unit</th>
            <th width="18%">Subtotal</th>
            <th width="10%" class="text-center">Remove</th>
        </tr>
    </thead>
    <tbody id="formset-container">
        {% for form in order_item_formset %}
        <tr class="formset-row" data-form-index="{{ forloop.counter0 }}">
            <td>
                {{ form.id }}

                <select name="{{ form.product.html_name }}"
                        class="form-control product-select"
                        data-row-index="{{ forloop.counter0 }}"
                        required>
                    <option value="">-- Select Product --</option>
                    {% for product in products_data %}
                    <option value="{{ product.id }}"
                            data-price="{{ product.price }}"
                            data-unit="{{ product.unit }}"
                            data-stock="{{ product.stock }}"
                            {% if form.instance.product_id == product.id %}selected{% endif %}>
                        {{ product.name }} - {{ product.code }} (Stock: {{ product.stock }} {{ product.unit }})
                    </option>
                    {% endfor %}
                </select>

                {% if form.product.errors %}
                    <small class="text-danger">{{ form.product.errors }}</small>
                {% endif %}
            </td>
            <td>
                <input type="number"
                       name="{{ form.unit_price.html_name }}"
                       class="form-control unit-price-input"
                       step="0.01"
                       value="{{ form.instance.unit_price|default:0 }}"
                       readonly
                       required>
            </td>
            <td>
                <input type="number"
                       name="{{ form.quantity.html_name }}"
                       class="form-control quantity-input"
                       min="1"
                       value="{{ form.instance.quantity|default:1 }}"
                       data-row-index="{{ forloop.counter0 }}"
                       required>
                {% if form.quantity.errors %}
                    <small class="text-danger">{{ form.quantity.errors }}</small>
                {% endif %}
            </td>
            <td>
                <input type="text" class="form-control unit-display" readonly>
            </td>
            <td>
                <input type="text" class="form-control subtotal-display" readonly>
            </td>
            <td class="text-center">
                {% if form.instance.pk %}
                    {{ form.DELETE }}
                    <label for="{{ form.DELETE.id_for_label }}" class="btn btn-danger btn-sm">
                        <i class="fas fa-trash"></i>
                    </label>
                {% else %}
                    <button type="button" class="btn btn-danger btn-sm remove-row-btn">
                        <i class="fas fa-trash"></i>
                    </button>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
    <tfoot>
        <tr class="table-light">
            <td colspan="4" class="text-end"><strong>Total:</strong></td>
            <td colspan="2">
                <h5 class="text-danger mb-0" id="totalAmount">0 ₫</h5>
            </td>
        </tr>
    </tfoot>
</table>
</div>
</div>
</div>

<hr class="my-4">

<div class="row">
<div class="col-lg-9">
<div class="form-group">
<label>Order Note</label>
{{ order_form.note }}
</div>
</div>

<div class="col-lg-3">
<div class="form-group">
<label>Payment Method</label>
{{ order_form.payment_method }}
</div>
</div>
</div>

<div class="row">
<div class="col-lg-12">
<button type="submit" class="btn btn-submit me-2">
<i class="fas fa-save me-1"></i>Save Order
</button>
<a href="{% url 'order_list' %}" class="btn btn-cancel">
<i class="fas fa-times me-1"></i>Cancel
</a>
</div>
</div>
</form>
</div>
</div>

</div>
</div>

<table style="display: none;">
<tbody id="empty-form-template">
<tr class="formset-row" data-form-index="__prefix__">
<td>
<select name="items-__prefix__-product"
class="form-control product-select"
data-row-index="__prefix__"
required>
<option value="">-- Select Product --</option>
{% for product in products_data %}
<option value="{{ product.id }}"
data-price="{{ product.price }}"
data-unit="{{ product.unit }}"
data-stock="{{ product.stock }}">
{{ product.name }} - {{ product.code }} (Stock: {{ product.stock }} {{ product.unit }})
</option>
{% endfor %}
</select>
</td>
<td>
<input type="number"
name="items-__prefix__-unit_price"
class="form-control unit-price-input"
step="0.01"
value="0"
readonly
required>
</td>
<td>
<input type="number"
name="items-__prefix__-quantity"
class="form-control quantity-input"
min="1"
value="1"
data-row-index="__prefix__"
required>
</td>
<td>
<input type="text" class="form-control unit-display" readonly>
</td>
<td>
<input type="text" class="form-control subtotal-display" readonly>
</td>
<td class="text-center">
<button type="button" class="btn btn-danger btn-sm remove-row-btn">
<i class="fas fa-trash"></i>
</button>
</td>
</tr>
</tbody>
</table>

<script>
// Products data
const productsData = {{ products_data|safe }};

// Formset variables
let totalFormsInput = document.getElementById('id_items-TOTAL_FORMS');
let formsetContainer = document.getElementById('formset-container');
let emptyFormTemplate = document.getElementById('empty-form-template').innerHTML;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Add change listeners to existing rows
    attachEventListeners();

    // Calculate initial total
    calculateTotal();

    // Add item button
    document.getElementById('addItemBtn').addEventListener('click', addFormRow);
});

// Attach event listeners to product selects and quantity inputs
function attachEventListeners() {
    // Product select change
    document.querySelectorAll('.product-select').forEach(select => {
        select.addEventListener('change', function() {
            updateProductInfo(this);
        });

        // Trigger change if already has value (for edit mode)
        if (select.value) {
            updateProductInfo(select);
        }
    });

    // Quantity input change
    document.querySelectorAll('.quantity-input').forEach(input => {
        input.addEventListener('input', function() {
            calculateTotal();
        });
    });

    // Remove row buttons
    document.querySelectorAll('.remove-row-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            removeFormRow(this);
        });
    });
}

// Update product info when select changes
function updateProductInfo(selectElement) {
    const row = selectElement.closest('tr');
    const productId = selectElement.value;

    if (productId) {
        const product = productsData.find(p => p.id == productId);

        if (product) {
            // Update unit price
            const unitPriceInput = row.querySelector('.unit-price-input');
            unitPriceInput.value = product.price;

            // Update unit display
            const unitDisplay = row.querySelector('.unit-display');
            unitDisplay.value = product.unit;

            // Set max quantity
            const quantityInput = row.querySelector('.quantity-input');
            quantityInput.max = product.stock;

            // Calculate total
            calculateTotal();
        }
    } else {
        // Clear fields if no product selected
        const unitPriceInput = row.querySelector('.unit-price-input');
        const unitDisplay = row.querySelector('.unit-display');
        const subtotalDisplay = row.querySelector('.subtotal-display');

        unitPriceInput.value = 0;
        unitDisplay.value = '';
        subtotalDisplay.value = '';

        calculateTotal();
    }
}

// Calculate total amount
function calculateTotal() {
    let total = 0;

    document.querySelectorAll('.formset-row').forEach(row => {
        // Check if row is marked for deletion
        const deleteCheckbox = row.querySelector('input[type="checkbox"][name*="DELETE"]');
        if (deleteCheckbox && deleteCheckbox.checked) {
            row.style.opacity = '0.5';
            return; // Skip deleted rows
        } else {
            row.style.opacity = '1';
        }

        const quantityInput = row.querySelector('.quantity-input');
        const unitPriceInput = row.querySelector('.unit-price-input');
        const subtotalDisplay = row.querySelector('.subtotal-display');

        if (quantityInput && unitPriceInput) {
            const quantity = parseInt(quantityInput.value) || 0;
            const unitPrice = parseFloat(unitPriceInput.value) || 0;
            const subtotal = quantity * unitPrice;

            // Update subtotal display
            if (subtotalDisplay) {
                // Kept Vietnamese locale for currency consistency since the symbol is ₫
                subtotalDisplay.value = formatMoney(subtotal) + ' ₫';
            }

            total += subtotal;
        }
    });

    document.getElementById('totalAmount').textContent = formatMoney(total) + ' ₫';
}

// Add new form row
function addFormRow() {
    const currentFormCount = parseInt(totalFormsInput.value);

    // Clone empty form template
    const newFormHtml = emptyFormTemplate.replace(/__prefix__/g, currentFormCount);

    // Insert new row
    formsetContainer.insertAdjacentHTML('beforeend', newFormHtml);

    // Update total forms count
    totalFormsInput.value = currentFormCount + 1;

    // Attach event listeners to new row
    const newRow = formsetContainer.lastElementChild;
    const productSelect = newRow.querySelector('.product-select');
    const quantityInput = newRow.querySelector('.quantity-input');
    const removeBtn = newRow.querySelector('.remove-row-btn');

    productSelect.addEventListener('change', function() {
        updateProductInfo(this);
    });

    quantityInput.addEventListener('input', function() {
        calculateTotal();
    });

    removeBtn.addEventListener('click', function() {
        removeFormRow(this);
    });
}

// Remove form row
function removeFormRow(button) {
    const row = button.closest('tr');

    // Check if it's the last row
    const visibleRows = document.querySelectorAll('.formset-row');
    if (visibleRows.length <= 1) {
        alert('There must be at least 1 product in the order!');
        return;
    }

    row.remove();
    calculateTotal();
}

// Format money
function formatMoney(amount) {
    return Math.round(amount).toLocaleString('vi-VN');
}

// Form validation before submit
document.getElementById('orderForm').addEventListener('submit', function(e) {
    const rows = document.querySelectorAll('.formset-row');
    let hasProduct = false;
    let stockError = false;

    rows.forEach(row => {
        const deleteCheckbox = row.querySelector('input[type="checkbox"][name*="DELETE"]');
        if (deleteCheckbox && deleteCheckbox.checked) {
            return; // Skip deleted rows
        }

        const productSelect = row.querySelector('.product-select');
        if (productSelect && productSelect.value) {
            hasProduct = true;

            // Check stock
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            const stock = parseInt(selectedOption.getAttribute('data-stock'));
            const quantity = parseInt(row.querySelector('.quantity-input').value);

            if (quantity > stock) {
                alert(`Product "${selectedOption.text}" has insufficient stock!`);
                stockError = true;
            }
        }
    });

    if (!hasProduct) {
        e.preventDefault();
        alert('Please select at least one product!');
        return false;
    }

    if (stockError) {
        e.preventDefault();
        return false;
    }
});
</script>

{% endblock %}